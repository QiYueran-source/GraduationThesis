# 思路改进  
先制定一个简单的方案，更接近基准研究，更好实现  

## 1.Agent设定修改与细化  
### 1.1 修改  
(1)由原先模仿市场的“机构”“散户”模型->“异质化”的同质投资者设定    
- 同质：所有投资者拥有一样的设定字段（类似神经网络的结构一致）   
- 异质：字段的配置不同（如激进/保守/理性，因子类别关注度排序...）      

(2)由原先的大量原始数据转为因子数据，参考基准研究，降低ai分析难度  



### 1.2 细化  
Agent的信息传递依赖AgentState类，需要设计，设定为四类数据的组合  
- 1.固定设置，既AI的先天属性，是不能变的，异质性的主要来源  
- 2.外部数据：从外部获取的数据，如因子数据，历史信息等（只包含当前窗口）    
- 3.内部数据：AI生成的数据，如本期分析，本期预测值（只包含当前窗口）
- 4.记忆数据：通过Memory中间件管理的历史数据和先天知识  

#### 固定设置  
- 1.心理特征  
    - 乐观程度：乐观、客观、悲观（倾向于高估/客观/低估收益）       
    - 理性程度：理性、随机波动、感性（方差小，随机，大）           
    - 风险偏好：高、中、低    
    
- 2.数据能力    
    - 分析能力：insight的长度       
    - 因子回顾能力：回顾过去因子的期数(0,4,6,12，最多不超过一个窗口)    
    - 分析回顾能力：回顾过去分析报告的能力(0,1,2)    

- 3.数据获取：剔除null，null的出现模拟了数据的可得性    

#### 外部数据（只包含当前窗口）  
- 1.当前窗口的因子数据（历史因子数据通过Memory管理）    
- 2.上一期的实际收益率，以及和预测的误差         

#### 内部数据（只包含当前窗口）  
- 1.信念belief，包含：  
    - 1.1 relation，即因子和收益率的潜在关系  
    - 1.2 attention，对因子类别关注的排序   
- 2.analyse，即按照belief，对当期窗口的分析  
- 3.预测结果pred  
- 4.诊断结果dignose

#### 记忆数据（通过Memory中间件管理）  
- 1.历史因子数据：根据factor_review_capability按需加载  
- 2.历史分析数据：根据analysis_review_capability按需加载  
- 3.历史预测数据：根据analysis_review_capability按需加载  
- 4.历史belief数据：根据analysis_review_capability按需加载  
- 5.先天知识：所有Agent共享的因子知识库

## 2.数据流  

### 2.1 数据存储策略
- **数据库（PostgreSQL）**：永久保存所有历史数据，用于完整的数据流记录和回溯
- **Redis**：作为共享缓存层，用于多Agent并行训练和互学习
    - 保存当前窗口的belief、analyse、pred、factors
    - 过期时间根据回顾能力设定（自动清理旧数据）
    - 优先从Redis加载历史数据（快速），如果Redis没有则从数据库加载（降级）
- **Memory中间件**：按回顾能力从Redis或数据库加载历史数据

### 2.2 训练流程
1.生成agent，即随机初始化固定配置   
    - 保存基本配置到数据库
    
2.初步训练    
    - 传入第0个窗口的因子数据和收益率    
    （定义，第n个窗口的收益率为窗口的下一个月的收益率）  
    - 要求agent学习收益和因子的非线性关系/重要程度排序，生成初步belief  
    - 传入第1期的因子数据，根据belief，生成分析结果analyse和预测收益率pred  
    - 保存数据：
        - 保存到数据库（永久保存）
        - 保存到Redis（共享缓存，过期时间根据回顾能力设定）
    
3.训练迭代  
    - 训练下一个窗口  
        - 通过Memory中间件加载上几个训练的belief、analyse和pred（优先从Redis加载）
        - 生成问题诊断dignose  
        - 根据dignose，修正belief(修正relation和attention)  
        - 根据修正belief，生成分析analyse   
        - 根据analyse，生成下一期的收益率预测  
        - 保存数据：
            - 保存到数据库（永久保存）
            - 保存到Redis（共享缓存，过期时间根据回顾能力设定）
    - 循环训练

### 2.3 多Agent并行训练
- 训练开始前：从数据库批量加载历史数据到Redis（预热，可选）
- 多个Agent并行训练：从Redis读取历史数据（快速、共享，减少数据库压力）
- 训练完成后：保存新数据到数据库和Redis

### 2.4 Agent互学习
- Agent训练完成：保存到Redis（共享缓存，实时可用）
- 其他Agent需要学习：直接从Redis读取（快速、高并发）
- 支持按Agent ID、股票代码等灵活查询  

## 3.技术问题  
1. 如何保证给定输入的输出一致？  
    - 设置很低的温度和确定的seed  
    
2. 如何保证数据不泄露？  
    - 不使用会话模式
    
3. 性能优化  
    - Redis作为共享缓存层，减少数据库压力
    - Memory中间件优先从Redis加载，降级到数据库
    - 支持多Agent并行训练和互学习的高性能访问